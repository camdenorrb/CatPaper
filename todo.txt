Make damage handling more thread safe, currently it relies on a global variable, ideally it would work via damagesource only